<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org">
  <head th:fragment="title">
    <title>Dashboard - OinkVest</title>
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
  </head>
  <body th:fragment="content">
    <div
      th:if="${success}"
      class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"
    >
      <span th:text="${success}"></span>
    </div>

    <div
      th:if="${error}"
      class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"
    >
      <span th:text="${error}"></span>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Seletor de moeda e gráfico -->
      <div class="lg:col-span-2 bg-white p-6 rounded shadow">
        <!-- Par e preço -->
        <form
          class="flex items-center gap-4 mb-4"
          method="get"
          th:action="@{/dashboard}"
        >
          <div
            id="pair"
            th:attr="hx-get=@{/dashboard/fragment-pares(symbol=${moedaSelecionada})}"
            hx-trigger="load"
            hx-target="#pair"
            hx-swap="outerHTML"
          >
            <select
              disabled
              class="w-40 border border-gray-300 rounded px-3 py-2 text-lg font-medium text-gray-800"
            >
              <option>Carregando...</option>
            </select>
          </div>
          <div
            class="text-lg font-medium text-gray-800"
            id="precoAtualHeader"
            th:attr="hx-get=@{/dashboard/fragment-preco(symbol=${moedaSelecionada}, fragment='preco-header')}"
            hx-trigger="load"
            hx-target="#precoAtualHeader"
            hx-swap="outerHTML"
          >
            <span class="animate-pulse text-gray-500">Carregando preço...</span>
          </div>
        </form>
        <div class="w-fit h-fit">
        <select name="intervalo" id="intervalo" class="w-40 border border-gray-300 rounded px-3 py-2 text-lg font-medium text-gray-800 mb-4">
          <option value="1s">1s</option>
          <option value="1m" selected>1m</option>
          <option value="15m">15m</option>
          <option value="1h">1h</option>

        </select>
      </div>
        <!-- Gráfico -->
        <div id="grafico-wrapper" 
        hx-get="/grafico-fragment" 
        hx-trigger="load" 
        hx-target="#grafico-wrapper" h
        x-swap="outerHTML">
          <!-- Enquanto carrega, exibe um spinner ou mensagem -->
        </div>
      <!-- Operações -->
      <div class="space-y-6">
        <div class="bg-white p-6 rounded shadow">
          <h3 class="text-lg font-bold mb-4" id="tituloOperacao">
            Operar BTCUSDT
          </h3>

          <form
            class="space-y-4"
            method="post"
            th:action="@{/dashboard/operar}"
            id="formOperacao"
          >
            <label class="block text-sm font-medium text-gray-700"
              >Preço Atual</label
            >
            <div
              id="precoOperacao"
              th:attr="hx-get=@{/dashboard/fragment-preco(symbol=${moedaSelecionada}, fragment='preco-hidden')}"
              hx-trigger="load"
              hx-target="#precoOperacao"
              hx-swap="outerHTML"
            >
              <input type="hidden" value="..." />
            </div>
            <div
              id="precoAtualInput"
              th:attr="hx-get=@{/dashboard/fragment-preco(symbol=${moedaSelecionada}, fragment='preco-input')}"
              hx-trigger="load"
              hx-target="#precoAtualInput"
              hx-swap="outerHTML"
            >
              <input readonly value="Carregando..." type="text" />
            </div>
            <label class="block text-sm font-medium text-gray-700"
              >Quantidade</label
            >
            <input
              class="w-full mb-2 px-3 py-2 border rounded"
              id="quantidadeInput"
              name="quantidade"
              step="0.0001"
              type="number"
              min="0.0001"
              value="0.0001"
            /><label class="block text-sm font-medium text-gray-700"
              >Total Estimado</label
            >
            <input
              class="w-full mb-4 px-3 py-2 border rounded"
              id="totalEstimado"
              readonly=""
              type="text"
              value="$0.00000000"
            />
            <input
              id="tipoOperacao"
              name="tipo"
              type="hidden"
              value="COMPRA"
            /><input
              name="moeda"
              th:value="${moedaSelecionada}"
              type="hidden"
            />
            <div class="flex gap-4">
              <button
                id="botaoCompra"
                class="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700"
                data-tipo="COMPRA"
                type="submit"
              >
                Comprar</button
              ><button
                id="botaoVenda"
                class="flex-1 bg-red-600 text-white py-2 rounded hover:bg-red-700"
                data-tipo="VENDA"
                type="submit"
              >
                Vender
              </button>
            </div>
          </form>
        </div>
        <div class="bg-white p-6 rounded shadow">
          <h3 class="text-lg font-bold mb-4">
            Detalhes (<span th:text="${moedaSelecionada}"></span>)
          </h3>
          <p class="text-sm">
            Saldo (<span th:text="${moedaSelecionada}"></span>):
            <span
              class="float-right font-bold text-gray-800"
              th:text="${#numbers.formatDecimal(detalhesMoeda.saldoMoeda, 1, 'COMMA', 4, 'POINT')}"
            ></span>
          </p>
          <p class="text-sm">
            Preço Médio (<span th:text="${moedaSelecionada}"></span>):
            <span
              class="float-right font-bold text-gray-800"
              th:text="'$' + ${#numbers.formatDecimal(detalhesMoeda.precoMedio, 1, 'COMMA', 8, 'POINT')}"
            ></span>
          </p>
          <p class="text-sm">
            Saldo disponível (USDT):
            <span
              class="float-right font-bold text-gray-800"
              th:text="'$' + ${#numbers.formatDecimal(saldoFiat, 1, 'COMMA', 8, 'POINT')}"
            ></span>
          </p>
        </div>
      </div>
    </div>
    <!-- Gráfico estático por enquanto -->
     <!-- Dentro do corpo da página principal -->

<!-- Script global que será usado após o fragmento -->
<script>
  const intervalo = document.getElementById('intervalo')
  async function fetchAndRender() {
    try {
      const res = await fetch(`/grafico-json?symbol=${parSelecionado}&interval=${intervalo.value}`);
      const candles = await res.json();

      if (!Array.isArray(candles)) throw new Error("Formato inválido");

      const labels = candles.map(c => new Date(c.time).toLocaleTimeString());
      const dados = candles.map(c => c.close);

      if (window.chart && window.chart.data) {
        window.chart.data.labels = labels;
        window.chart.data.datasets[0].data = dados;
        window.chart.update();
      } else {
        console.error("Gráfico não inicializado.");
      }
    } catch (err) {
      console.error("Erro ao buscar dados:", err);
    }
  }

  document.body.addEventListener('htmx:afterSettle', function (evt) {
    if (evt.target.id === 'grafico-wrapper') {
      console.log("Fragmento carregado, buscando dados...");
      fetchAndRender();
      setInterval(fetchAndRender,1000)
    }
  });
</script>

    <!-- WebSocket + cálculo total -->
    <script th:inline="javascript">
      const parSelecionado = /*[[${moedaSelecionada}]]*/ "BTCUSDT";

      const precoInput = document.getElementById("precoAtualInput");
      const precoHeader = document.getElementById("precoAtualHeader");
      const tituloOperacao = document.getElementById("tituloOperacao");

      const quantidadeInput = document.getElementById("quantidadeInput");
      const totalEstimado = document.getElementById("totalEstimado");

      const formOperacao = document.getElementById("formOperacao");
      const botaoCompra = document.getElementById("botaoCompra");
      const botaoVenda = document.getElementById("botaoVenda");

      const tipoOperacaoInput = document.getElementById("tipoOperacao");

      let precoAtual = 0;
      let operacaoSelecionada = "";

      function atualizarTotal() {
        const qtd = parseFloat(quantidadeInput.value).toFixed(4);
        if (!isNaN(qtd) && !isNaN(precoAtual)) {
          const total = qtd * precoAtual;
          totalEstimado.value = `$${total.toFixed(8)}`;
        } else {
          totalEstimado.value = "$0.00";
        }
      }

      quantidadeInput.addEventListener("input", atualizarTotal);

      const ws = new WebSocket(
        "wss://stream.binance.com:9443/ws/" +
          parSelecionado.toLowerCase() +
          "@ticker"
      );

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        precoAtual = parseFloat(data.c).toFixed(8);

        //tem que fazer isso aqui novamente, pois quando carrega a pagina o htmx substitui o div e o precoHeader nao pode mais ser encontrado, deve ser buscado novamente.
        const precoHeader = document.getElementById("precoAtualHeader");
        const precoInput = document.getElementById("precoAtualInput");

        if (precoInput) precoInput.value = `$${precoAtual}`;
        if (precoHeader) precoHeader.innerHTML = ` ($${precoAtual})`;

        const precoOperacao = document.getElementById("precoOperacao");
        if (precoOperacao) precoOperacao.value = precoAtual.toString();
        atualizarTotal();
      };

      // opcional: exibir nome do par no título
      if (tituloOperacao) {
        tituloOperacao.textContent = `Operar ${parSelecionado}`;
      }

      formOperacao.addEventListener("submit", function (e) {
        botaoCompra.disabled = true;
        botaoVenda.disabled = true;

        botaoCompra.textContent = "Processando...";
        botaoVenda.textContent = "Processando...";
      });

      botaoCompra.addEventListener("click", function (e) {
        e.preventDefault();
        operacaoSelecionada = "COMPRA";
        confirmarEEnviar();
      });

      botaoVenda.addEventListener("click", function (e) {
        e.preventDefault();
        operacaoSelecionada = "VENDA";
        confirmarEEnviar();
      });

      function confirmarEEnviar() {
        if (
          confirm(
            `Deseja realmente realizar a operação de ${operacaoSelecionada}?`
          )
        ) {
          tipoOperacaoInput.value = operacaoSelecionada;

          botaoCompra.disabled = true;
          botaoVenda.disabled = true;

          botaoCompra.textContent = "Processando...";
          botaoVenda.textContent = "Processando...";

          formOperacao.submit();
        }
      }
    </script>
  </body>
</html>
